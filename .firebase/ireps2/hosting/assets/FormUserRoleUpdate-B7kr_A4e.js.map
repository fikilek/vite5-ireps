{"version":3,"file":"FormUserRoleUpdate-B7kr_A4e.js","sources":["../../src/components/forms/auth/FormUserRoleUpdate.jsx"],"sourcesContent":["import { useContext, useEffect, useState } from \"react\";\nimport { toast } from \"react-toastify\";\nimport { Form, Formik } from \"formik\";\nimport { getFunctions, httpsCallable } from \"firebase/functions\";\n\n// css\nimport \"@/components/forms/auth/FormUserRoleUpdate.css\";\n\n// custome hooks\nimport useModal from \"@/hooks/useModal.jsx\";\n\n// components\nimport FormFooter from \"@/components/forms/formFooter/FormFooter\";\nimport FormikControl from \"@/components/forms/formik/FormikControl\";\nimport FormError from \"@/components/forms/formError/FormError\";\nimport { ClaimsContext } from \"@/contexts/ClaimsContext\";\nimport HeaderGeneric from \"@/components/header/HeaderGeneric\";\nimport FormCloseBtn from \"@/components/forms/formBtns/FormCloseBtn\";\n\nconst roles = [\n\t{ key: \"guest\", value: \"Guest\", roleCode: \"GST\" },\n\t{ key: \"fieldworker\", value: \"Fieldworker\", roleCode: \"FWR\" },\n\t{ key: \"supervisor\", value: \"Supervisor\", roleCode: \"SPV\" },\n\t{ key: \"manager\", value: \"Manager\", roleCode: \"MNG\" },\n\t{ key: \"superuser\", value: \"Superuser\", roleCode: \"SPU\" },\n];\n\nconst areObjectsEqual = (obj1, obj2) => {\n\t// console.log(`obj1 newClaims`, obj1)\n\t// console.log(`obj2 oldClaims`, obj2)\n\n\tconst stringifiedObj1 = JSON.stringify(obj1);\n\tconst stringifiedObj2 = JSON.stringify(obj2);\n\tconst result = stringifiedObj1 === stringifiedObj2;\n\t// console.log(`result`, result);\n\tlet changeSet = {\n\t\tguest: {\n\t\t\told: \"\",\n\t\t\tnew: \"\",\n\t\t\tchange: \"\",\n\t\t},\n\t\tfieldworker: {\n\t\t\told: \"\",\n\t\t\tnew: \"\",\n\t\t\tchange: \"\",\n\t\t},\n\t\tsupervisor: {\n\t\t\told: \"\",\n\t\t\tnew: \"\",\n\t\t\tchange: \"\",\n\t\t},\n\t\tmanager: {\n\t\t\told: \"\",\n\t\t\tnew: \"\",\n\t\t\tchange: \"\",\n\t\t},\n\t\tsuperuser: {\n\t\t\told: \"\",\n\t\t\tnew: \"\",\n\t\t\tchange: \"\",\n\t\t},\n\t};\n\n\t// create claims change set\n\tfor (const role in changeSet) {\n\t\t// console.log(`role`, role)\n\t\tchangeSet[role][\"old\"] = obj2[role];\n\t\tchangeSet[role][\"new\"] = obj1[role];\n\t\tif (obj1[role] === obj2[role]) {\n\t\t\tchangeSet[role][\"change\"] = false;\n\t\t} else {\n\t\t\tchangeSet[role][\"change\"] = true;\n\t\t}\n\t}\n\t// console.log(`changeSet`, changeSet)\n\n\treturn { objectsEqual: result, changeSet };\n};\n\nconst FormUserRoleUpdate = props => {\n\t// console.log(`props`, props);\n\tconst { formData: data } = props;\n\t// console.log(`data`, data);\n\n\t// create error state\n\tconst [error, setError] = useState(\"\");\n\n\tconst { customClaims, setCustomClaims } = useContext(ClaimsContext);\n\t// console.log(`customClaims.roles`, customClaims.roles);\n\n\t// const { getCustomError } = useFirebase();\n\n\tconst functions = getFunctions();\n\n\tconst [isPending, setIsPending] = useState(null);\n\n\tconst [formikClaims, setFormikClaims] = useState({});\n\t// console.log(`formikClaims`, formikClaims);\n\n\tconst [claimsChangeSet, setClaimsChangeSet] = useState({});\n\n\tconst { closeModal } = useModal();\n\n\tuseEffect(() => {\n\t\tsetFormikClaims(data?.customClaims?.roles);\n\t}, []);\n\n\tuseEffect(() => {\n\t\tconst { changeSet } = areObjectsEqual(formikClaims, customClaims.roles);\n\t\tsetClaimsChangeSet(changeSet);\n\t}, [customClaims.roles, formikClaims]);\n\n\tconst onSubmit = e => {\n\t\tsetIsPending(prev => (prev = true));\n\n\t\tconst updateUserRole = httpsCallable(functions, \"updateUserRole\");\n\t\tupdateUserRole({ roles: e, uid: data.uid, changeSet: claimsChangeSet })\n\t\t\t.then(claimUpdateResult => {\n\t\t\t\tsetCustomClaims(prev => ({\n\t\t\t\t\t...prev,\n\t\t\t\t\troles: claimUpdateResult?.data?.userRecord?.customClaims?.roles,\n\t\t\t\t}));\n\n\t\t\t\ttoast(`Roles for user \"${data.displayName}\", updated succesfully`, {\n\t\t\t\t\tposition: \"bottom-left\",\n\t\t\t\t\tautoClose: 5000,\n\t\t\t\t\thideProgressBar: false,\n\t\t\t\t\tcloseOnClick: true,\n\t\t\t\t\tpauseOnHover: true,\n\t\t\t\t\tdraggable: true,\n\t\t\t\t\tprogress: undefined,\n\t\t\t\t\ttheme: \"light\",\n\t\t\t\t});\n\t\t\t\t// close modal\n\t\t\t\tcloseModal();\n\t\t\t\tsetIsPending(\n\t\t\t\t\tprev => (prev = claimUpdateResult.data.userRecord ? false : true)\n\t\t\t\t);\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tconsole.log(`error updating role: `, err.message);\n\t\t\t\tsetError(err.message);\n\t\t\t\tsetIsPending(false);\n\t\t\t});\n\t};\n\tconst validate = values => {\n\t\tlet errors = {};\n\n\t\t// iterate through values. If one of the values is true, retun with no errors. If all of them are false, return error.\n\t\tfor (const role in values) {\n\t\t\tif (values[role]) return errors;\n\t\t}\n\t\terrors.roles = \"User must have at least ONE role\";\n\n\t\treturn errors;\n\t};\n\n\tconst handleChange = e => {\n\t\t// console.log(`form has changed : e.target.value :`, e.target.value);\n\t\t// console.log(`form has changed : e.target : `, e.target.checked);\n\t\tsetFormikClaims({\n\t\t\t...formikClaims,\n\t\t\t[e.target.value]: e.target.checked,\n\t\t});\n\t};\n\n\treturn (\n\t\t<div className=\"form-wrapper\">\n\t\t\t<div className=\"form-container user-role-update \">\n\t\t\t\t<Formik\n\t\t\t\t\tinitialValues={data.customClaims.roles}\n\t\t\t\t\tonSubmit={onSubmit}\n\t\t\t\t\tvalidate={validate}\n\t\t\t\t\tenableReinitialize={true}\n\t\t\t\t>\n\t\t\t\t\t{formik => {\n\t\t\t\t\t\t// console.log(`formik.values`, formik.values);\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<Form onChange={handleChange}>\n\t\t\t\t\t\t\t\t\t<HeaderGeneric\n\t\t\t\t\t\t\t\t\t\thl1=\"User Role Updater Form\"\n\t\t\t\t\t\t\t\t\t\thr1={`${data.displayName}`}\n\t\t\t\t\t\t\t\t\t><FormCloseBtn /></HeaderGeneric>\n\n\t\t\t\t\t\t\t\t\t<div className=\"user-role-update\">\n\t\t\t\t\t\t\t\t\t\t<div className=\"uru uru-sub-heading\">\n\t\t\t\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\t\t\t\t{`The user has the existing roles shown below. Click on the checkbox to either add a new role or remove the existig role and submit. Roles rules apply`}\n\t\t\t\t\t\t\t\t\t\t\t\t.\n\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div className=\"uru check-btns\">\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"user-roles\">\n\t\t\t\t\t\t\t\t\t\t\t\t<FormikControl\n\t\t\t\t\t\t\t\t\t\t\t\t\tcontrol=\"checkbox\"\n\t\t\t\t\t\t\t\t\t\t\t\t\tlabel=\"\"\n\t\t\t\t\t\t\t\t\t\t\t\t\tname={\"roles\"}\n\t\t\t\t\t\t\t\t\t\t\t\t\troles={roles}\n\t\t\t\t\t\t\t\t\t\t\t\t\tclaims={data.customClaims.roles}\n\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t{formik.errors.roles && (\n\t\t\t\t\t\t\t\t\t\t\t\t\t<FormError errorMsg={formik.errors.roles} />\n\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t{error && <FormError errorMsg={error} />}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t<FormFooter formik={formik} signState={{ isPending: isPending }} />\n\t\t\t\t\t\t\t\t</Form>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t);\n\t\t\t\t\t}}\n\t\t\t\t</Formik>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default FormUserRoleUpdate;\n"],"names":["roles","areObjectsEqual","obj1","obj2","stringifiedObj1","stringifiedObj2","result","changeSet","role","FormUserRoleUpdate","props","data","error","setError","useState","customClaims","setCustomClaims","useContext","ClaimsContext","functions","getFunctions","isPending","setIsPending","formikClaims","setFormikClaims","claimsChangeSet","setClaimsChangeSet","closeModal","useModal","useEffect","_a","onSubmit","e","prev","httpsCallable","claimUpdateResult","_c","_b","toast","err","validate","values","errors","handleChange","jsx","Formik","formik","Fragment","jsxs","Form","HeaderGeneric","FormCloseBtn","FormikControl","FormError","FormFooter"],"mappings":"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"}