import{r as p,u as k,q as F,e as R,w as L,c as $,d as O,f as P,k as y,j as a,m as v,n as D,I as W,p as K,E as S,s as x,M as b,C as j,t as A,v as U,S as B,x as I,a as _}from"./index-Dyq_Y629.js";import{u as H}from"./useTrns-BqU6BRGX.js";import{T as z,u as V}from"./TableBtnsPossibleTrnsOnAst-CGVQkfPr.js";import{u as E}from"./useIrepsMap-gnSRCniL.js";import{M as T}from"./index.esm-B_Afp0Vg.js";import q from"./FormErf-CkbiEYOQ.js";import"./TableTrnsOnAst-CRVaYHFq.js";/* empty css                        */import{P as G}from"./PageTitle-CEEYCQfL.js";import"./ag-theme-quartz-Aqy0TGCY.js";const Z=m=>{const[t,o]=p.useState([]),[e,i]=p.useState(""),{getDocument:h}=H("users"),{user:n}=k(),r=n==null?void 0:n.uid;return p.useEffect(()=>{h(r).then(l=>{const{workbase:s}=l==null?void 0:l.doc,d=F($(O,m),L("erf.address.lmMetro","==",s),R("metadata.updatedAtDatetime","desc"));i(""),P(d,c=>{const u=[];c.docs.forEach(f=>{u.push({id:f.id,...f.data()})}),o(u)},c=>{console.log("firestore err",c.message),i(c.message)}),i("")})},[]),{asts:t,error:e}},J=()=>{const{asts:m,error:t}=Z("asts");return{asts:m,astsTableFields:[{field:"id",headerName:"System Id",width:200,hide:!0},{headerName:"Created",children:[{field:"metadata.createdByUser",columnGroupShow:"closed",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdByUser",columnGroupShow:"open",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:150,cellRenderer:e=>{const h=new y(e.value.seconds,e.value.nanoseconds).toDate();return a.jsx(v,{date:h,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:e=>e.data.metadata.createdAtDatetime,hide:!1}]},{headerName:"Updated",children:[{field:"metadata.updatedByUser",columnGroupShow:"closed",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedByUser",columnGroupShow:"open",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:150,cellRenderer:e=>{const h=new y(e.value.seconds,e.value.nanoseconds).toDate();return a.jsx(v,{date:h,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:e=>e.data.metadata.updatedAtDatetime,hide:!1}]},{field:"erf.erfNo",headerName:"Erf No",width:100,tooltipField:"Erf the ast belong to"},{headerName:"Meter Description",children:[{field:"astData.astNo",headerName:"Meter No",width:170,columnGroupShow:"closed",hide:!1},{field:"astData.astCatergory",headerName:"Catergory",columnGroupShow:"open",width:150,hide:!0},{field:"astData.astManufacturer",headerName:"Manufacturer (Brand)",columnGroupShow:"open",width:200,hide:!1},{field:"astData.astName",headerName:"Ast Technical Name",columnGroupShow:"open",width:150,hide:!1},{field:"astData.astState",headerName:"State",columnGroupShow:"open",width:150,hide:!1}]},{field:"",headerName:"Meter Media",width:150,cellRenderer:e=>a.jsx(D,{data:e,children:e.value}),cellRendererParams:{modalName:"mediaMobileAsts",width:"4rem",irepsKeyItem:"asts",displayMode:"modal"},valueGetter:e=>{var h,n,r,l;return(n=(h=e==null?void 0:e.data)==null?void 0:h.media)!=null&&n.length?(l=(r=e==null?void 0:e.data)==null?void 0:r.media)==null?void 0:l.length:0}},{field:"astData.astState.state",headerName:"Meter State",width:250,valueGetter:e=>{var h,n,r,l,s,d,c,u,f,N,w,M,C,g;let i="";return((h=e.data)==null?void 0:h.astData.astState.state)==="stores"&&(i=`${(n=e.data)==null?void 0:n.astData.astState.state} : ${(r=e.data)==null?void 0:r.astData.astState.location}`),((l=e.data)==null?void 0:l.astData.astState.state)==="service"&&(i=`service : ${(s=e.data)==null?void 0:s.erf.address.lmMetro} - ${(d=e.data)==null?void 0:d.erf.erfNo}`),((c=e.data)==null?void 0:c.astData.astState.state)==="temper"&&(i=`temper : ${(u=e.data)==null?void 0:u.erf.address.lmMetro} - ${(f=e.data)==null?void 0:f.erf.erfNo}`),(((N=e.data)==null?void 0:N.astData.astState.state)==""||((w=e.data)==null?void 0:w.astData.astState.state)==null||((M=e.data)==null?void 0:M.astData.astState.state)==null)&&(i=`service : ${(C=e.data)==null?void 0:C.erf.address.lmMetro} - ${(g=e.data)==null?void 0:g.erf.erfNo}`),i}},{field:"trns",headerName:"Trns On Meter",width:320,cellRenderer:z,hide:!1,valueGetter:e=>e.data},{field:"location.gps",columnGroupShow:"closed",headerName:"Meter on Map",cellRenderer:e=>a.jsx(D,{data:e,children:a.jsx(W.Provider,{value:{color:"blue",fontSize:"1rem"},children:a.jsx(K,{})})}),cellRendererParams:{modalName:"showAstOnMap",width:"3rem"},valueGetter:e=>{var n,r,l,s,d,c;const i=Number((l=(r=(n=e.data)==null?void 0:n.location)==null?void 0:r.gps)==null?void 0:l.lat),h=Number((c=(d=(s=e.data)==null?void 0:s.location)==null?void 0:d.gps)==null?void 0:c.lng);return`${i.toFixed(3)} / ${h.toFixed(3)}`},width:140},{headerName:"Meter Specific Data",children:[{field:"astData.meter.type",headerName:"Meter Type",width:150,hide:!1},{field:"astData.meter.phase",headerName:"Meter Phase",width:150,hide:!1}]},{headerName:"Anomalies",children:[{field:"anomalies.anomaly",columnGroupShow:"closed",headerName:"Anomaly",width:200},{field:"anomalies.anomalyDetail",columnGroupShow:"open",headerName:"Anomaly Detail",width:300}]},{headerName:"Meter Location",children:[{field:"location.address",columnGroupShow:"closed",headerName:"Ast Address",width:450},{field:"location.premises",columnGroupShow:"closed",headerName:"Premises",width:120},{field:"location.insideBox",columnGroupShow:"closed",headerName:"InsideBox",width:120}]},{headerName:"Keypad",children:[{field:"astData.meter.keypad.keypadAccess",columnGroupShow:"open",headerName:"Keypad Access?",width:150},{field:"astData.meter.keypad.serialNo",columnGroupShow:"open",headerName:"Keypad Serial No",width:160},{field:"astData.meter.keypad.comment",columnGroupShow:"open",headerName:"Keypad Comment",width:300}]},{headerName:"Circuit Breaker (CB)",children:[{field:"astData.meter.cb.isThereCb",columnGroupShow:"open",headerName:"CB There?",width:150},{field:"astData.meter.cb.size",columnGroupShow:"open",headerName:"CB (Amps)",width:150},{field:"astData.meter.cb.comment",columnGroupShow:"open",headerName:"CB Comment",width:300}]},{headerName:"Seal",children:[{field:"astData.meter.seal.meterSealed",columnGroupShow:"open",headerName:"Meter Sealed?",width:150},{field:"astData.meter.seal.sealNo",columnGroupShow:"open",headerName:"Seal No",width:150},{field:"astData.meter.seal.comment",columnGroupShow:"open",headerName:"Seal Comment",width:300}]},{field:"serviceConnection.configuration",columnGroupShow:"open",headerName:"Service Connection",width:300}],error:t}},Q=()=>{const{erfsContext:m,setErfsContext:t}=p.useContext(S),o=x(),{displayLMWardBoundaries:e,state:i,fitWardBoundary:h}=E(),{lmWardBoundaries:n,lmBoundary:r}=i;p.useEffect(()=>{o&&e(o)},[o,n]);const l=s=>{const d=s.currentTarget.value,c=n.find(u=>Number(u.ward)===Number(d));d==="All Wards"?(h(o,r),t({...m,ward:null})):(h(o,c.wardBoundary,c.ward),t({...m,ward:c.ward}))};return a.jsx(b,{position:j.TOP_LEFT,style:{margin:"1.6rem"},children:a.jsx("div",{className:"map-lm-ward-boundaries",children:a.jsxs("select",{onChange:l,className:"map-control-select",children:[a.jsx("option",{value:"All Wards",children:"All Wards"},"All Wards"),n&&n.map(s=>a.jsx("option",{value:s.ward,children:s.ward},s.ward))]})})})},X=m=>{const{center:t}=m,o=x(),{displayLmBoundary:e,state:i}=E(),{lmBoundary:h}=i;return p.useEffect(()=>{o&&e(o,t)},[h]),a.jsx("div",{className:"map-boundaries"})},Y=m=>{var l,s,d,c;const{erf:t,onClick:o,setMarkerRef:e}=m,i=p.useCallback(()=>o(t),[o,t]),h=p.useCallback(u=>e(u,t.id),[e,t.id]),{asts:n}=t,r=(n==null?void 0:n.length)||"";return a.jsxs(A,{position:{lat:(s=(l=t==null?void 0:t.address)==null?void 0:l.gps)==null?void 0:s.latitude,lng:(c=(d=t==null?void 0:t.address)==null?void 0:d.gps)==null?void 0:c.longitude},ref:h,onClick:i,children:[r&&a.jsx("button",{className:"erf-asts",children:r}),a.jsx("button",{className:"erf-no-btn",children:a.jsx("span",{className:"erf-no",children:t.erfNo})})]})},ee=()=>{const{erfsContext:m}=p.useContext(S),{erfs:t,ward:o}=p.useMemo(()=>m,[m]),e=t&&(t==null?void 0:t.filter(u=>{var f;return Number((f=u==null?void 0:u.address)==null?void 0:f.ward)===Number(o)})),[i,h]=p.useState({}),[n,r]=p.useState(null),l=p.useMemo(()=>e&&n?e.find(u=>u.id===n):null,[e,n]),s=x(),d=p.useMemo(()=>s?new T({map:s,zoom:10}):null,[s]);p.useEffect(()=>{d&&(d.clearMarkers(),d.addMarkers(Object.values(i)))},[d,i]);const c=p.useCallback((u,f)=>{h(N=>{if(u&&N[f]||!u&&!N[f])return N;if(u)return{...N,[f]:u};{const{[f]:w,...M}=N;return M}})},[s]);return a.jsxs(a.Fragment,{children:[e.map((u,f)=>a.jsx(Y,{erf:u,setMarkerRef:c},u.id)),n&&a.jsx(U,{anchor:i[n],onCloseClick:()=>r(null),headerDisabled:!0,children:a.jsx("div",{children:a.jsx(q,{data:{data:l}})})})]})},te=m=>{var d,c;const{ast:t,onClick:o,setMarkerRef:e}=m,{lat:i,lng:h}=(d=t==null?void 0:t.location)==null?void 0:d.gps,n=p.useCallback(()=>o(t),[o,t]),r=p.useCallback(u=>{if(e)return e(u,t.id)},[e,t.id]),{trns:l}=t,s=(l==null?void 0:l.length)||"";return a.jsxs(A,{position:{lat:Number(i),lng:Number(h)},ref:r,onClick:n,children:[s&&a.jsx("button",{className:"ast-asts",children:s}),a.jsx("button",{className:"ast-no-btn",children:a.jsx("span",{className:"ast-no",children:(c=t==null?void 0:t.astData)==null?void 0:c.astNo})})]})},ae=m=>{const{asts:t}=m,[o,e]=p.useState({}),[i,h]=p.useState(null);p.useMemo(()=>t&&i?t.find(s=>s.id===i):null,[t,i]);const n=x(),r=p.useMemo(()=>n?new T({map:n,zoom:10}):null,[n]);p.useEffect(()=>{r&&(r.clearMarkers(),r.addMarkers(Object.values(o)))},[r,o]);const l=p.useCallback((s,d)=>{e(c=>{if(s&&c[d]||!s&&!c[d])return c;if(s)return{...c,[d]:s};{const{[d]:u,...f}=c;return f}})},[]);return a.jsx(a.Fragment,{children:t==null?void 0:t.map((s,d)=>a.jsx(te,{ast:s,setMarkerRef:l},s.id))})},se=m=>{const{asts:t}=m,o=x(),e=t&&(t==null?void 0:t.map(r=>{var l,s;return{value:(l=r==null?void 0:r.astData)==null?void 0:l.astNo,label:(s=r==null?void 0:r.astData)==null?void 0:s.astNo,data:r}})),i=r=>{var l,s,d,c,u,f;o&&r&&(o.panTo({lat:Number((d=(s=(l=r.data)==null?void 0:l.location)==null?void 0:s.gps)==null?void 0:d.lat),lng:Number((f=(u=(c=r.data)==null?void 0:c.location)==null?void 0:u.gps)==null?void 0:f.lng)}),o.setZoom(20))},h=r=>null,n={control:r=>({...r,backgroundColor:"lightgray",padding:"0.11rem"}),option:(r,l)=>({...r,borderBottom:"1px dotted pink",color:l.isSelected?"white":"black",backgroundColor:l.isSelected?"hotpink":"white"})};return a.jsx(b,{position:j.LEFT_TOP,style:{margin:"1.6rem"},children:a.jsxs("div",{className:"map-ast-filter",children:[a.jsx("div",{className:"maf",children:a.jsx("h2",{children:"Mn"})}),a.jsx(B,{defaultValue:"Meter No",options:e,isClearable:!0,onChange:i,clearValue:h,styles:n})]})})},re=()=>{const m=x(),{erfsContext:t}=p.useContext(S),{erfs:o,ward:e}=p.useMemo(()=>t,[t]),i=o&&(o==null?void 0:o.filter(s=>{var d;return Number((d=s==null?void 0:s.address)==null?void 0:d.ward)===Number(e)})),h=i&&i.map(s=>({value:s.erfNo,label:s.erfNo,data:s})),n=s=>{var d,c,u,f,N,w;m&&s&&(m.panTo({lat:Number((u=(c=(d=s.data)==null?void 0:d.address)==null?void 0:c.gps)==null?void 0:u.latitude),lng:Number((w=(N=(f=s.data)==null?void 0:f.address)==null?void 0:N.gps)==null?void 0:w.longitude)}),m.setZoom(20))},r=s=>(console.log("clearing selected value",s),null),l={control:s=>({...s,backgroundColor:"lightgray",padding:"0.15rem"}),option:(s,d)=>({...s,borderBottom:"1px dotted pink",color:d.isSelected?"white":"black",backgroundColor:d.isSelected?"hotpink":"white"})};return a.jsx(b,{position:j.LEFT_TOP,style:{margin:"1.6rem"},children:a.jsxs("div",{className:"map-erf-filter",children:[a.jsx("div",{className:"mef",children:a.jsx("h2",{children:"Erf"})}),a.jsx(B,{defaultValue:"Erf No",options:h,isClearable:!0,onChange:n,clearValue:r,styles:l})]})})},oe=m=>{const{asts:t,astsTableFields:o}=m;return a.jsx("div",{className:"map-main",children:a.jsxs(I,{children:[a.jsx(Q,{}),a.jsx(X,{center:"center"}),a.jsx(ae,{asts:t,astsTableFields:o}),a.jsx(ee,{}),a.jsx(se,{asts:t,astsTableFields:o}),a.jsx(re,{})]})})},de=m=>{const{phLl:t}=m,{user:o}=k(),{userFromUsers:e}=_(o==null?void 0:o.uid);return a.jsxs("div",{className:"map-header",children:[a.jsx("div",{className:"ph ph-left",children:a.jsxs("div",{className:"phLl",children:[a.jsx(G,{title:t}),a.jsx(G,{title:e.workbase})]})}),a.jsxs("div",{className:"ph ph-right",children:[a.jsx("div",{className:"phRl"}),a.jsx("div",{className:"phRr"})]})]})},we=()=>{V();const{asts:m,astsTableFields:t,error:o}=J();return a.jsxs("div",{className:"map",children:[a.jsx(de,{phLl:"Map"}),a.jsx("div",{className:"map-body",children:a.jsx(oe,{asts:m,astsTableFields:t})})]})};export{we as default};
