import{r as p,u as k,q as F,e as R,w as L,c as $,d as O,f as P,k as y,j as s,m as v,n as D,I as W,p as K,E as S,s as x,M as j,C as g,t as A,v as U,S as B,x as I,a as _}from"./index-2DC40iBv.js";import{u as H}from"./useTrns-RyE2jCXL.js";import{T as z,u as V}from"./TableBtnsPossibleTrnsOnAst-DbbmcL6C.js";import{u as E}from"./useIrepsMap-DAYH5mkw.js";import{M as T}from"./index.esm-6ez4wv5w.js";import q from"./FormErf-BIu6cPlj.js";import"./TableTrnsOnAst-B4jDXqnX.js";/* empty css                        */import{P as G}from"./PageTitle-BA-cU4c0.js";import"./ag-theme-quartz-r68l7Kj_.js";const Z=m=>{const[t,o]=p.useState([]),[e,l]=p.useState(""),{getDocument:h}=H("users"),{user:n}=k(),r=n==null?void 0:n.uid;return p.useEffect(()=>{h(r).then(i=>{const{workbase:a}=i==null?void 0:i.doc,d=F($(O,m),L("erf.address.lmMetro","==",a),R("metadata.updatedAtDatetime","desc"));l(""),P(d,c=>{const u=[];c.docs.forEach(f=>{u.push({id:f.id,...f.data()})}),o(u)},c=>{console.log("firestore err",c.message),l(c.message)}),l("")})},[]),{asts:t,error:e}},J=()=>{const{asts:m,error:t}=Z("asts");return{asts:m,astsTableFields:[{field:"id",headerName:"System Id",width:200,hide:!0},{headerName:"Created",children:[{field:"metadata.createdByUser",columnGroupShow:"closed",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdByUser",columnGroupShow:"open",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:150,cellRenderer:e=>{const h=new y(e.value.seconds,e.value.nanoseconds).toDate();return s.jsx(v,{date:h,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:e=>e.data.metadata.createdAtDatetime,hide:!1}]},{headerName:"Updated",children:[{field:"metadata.updatedByUser",columnGroupShow:"closed",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedByUser",columnGroupShow:"open",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:150,cellRenderer:e=>{const h=new y(e.value.seconds,e.value.nanoseconds).toDate();return s.jsx(v,{date:h,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:e=>e.data.metadata.updatedAtDatetime,hide:!1}]},{field:"erf.erfNo",headerName:"Erf No",width:100,tooltipField:"Erf the ast belong to"},{headerName:"Meter Description",children:[{field:"astData.astNo",headerName:"Meter No",width:170,columnGroupShow:"closed",hide:!1},{field:"astData.astCatergory",headerName:"Catergory",columnGroupShow:"open",width:150,hide:!0},{field:"astData.astManufacturer",headerName:"Manufacturer (Brand)",columnGroupShow:"open",width:200,hide:!1},{field:"astData.astName",headerName:"Ast Technical Name",columnGroupShow:"open",width:150,hide:!1},{field:"astData.astState",headerName:"State",columnGroupShow:"open",width:150,hide:!1}]},{field:"",headerName:"Meter Media",width:150,cellRenderer:e=>s.jsx(D,{data:e,children:e.value}),cellRendererParams:{modalName:"mediaMobileAsts",width:"4rem",irepsKeyItem:"asts",displayMode:"modal"},valueGetter:e=>{var h,n,r,i;return(n=(h=e==null?void 0:e.data)==null?void 0:h.media)!=null&&n.length?(i=(r=e==null?void 0:e.data)==null?void 0:r.media)==null?void 0:i.length:0}},{field:"astData.astState.state",headerName:"Meter State",width:250,valueGetter:e=>{var h,n,r,i,a,d,c,u,f,N,w,M,C,b;let l="";return((h=e.data)==null?void 0:h.astData.astState.state)==="stores"&&(l=`${(n=e.data)==null?void 0:n.astData.astState.state} : ${(r=e.data)==null?void 0:r.astData.astState.location}`),((i=e.data)==null?void 0:i.astData.astState.state)==="service"&&(l=`service : ${(a=e.data)==null?void 0:a.erf.address.lmMetro} - ${(d=e.data)==null?void 0:d.erf.erfNo}`),((c=e.data)==null?void 0:c.astData.astState.state)==="temper"&&(l=`temper : ${(u=e.data)==null?void 0:u.erf.address.lmMetro} - ${(f=e.data)==null?void 0:f.erf.erfNo}`),(((N=e.data)==null?void 0:N.astData.astState.state)==""||((w=e.data)==null?void 0:w.astData.astState.state)==null||((M=e.data)==null?void 0:M.astData.astState.state)==null)&&(l=`service : ${(C=e.data)==null?void 0:C.erf.address.lmMetro} - ${(b=e.data)==null?void 0:b.erf.erfNo}`),l}},{field:"trns",headerName:"Trns On Meter",width:320,cellRenderer:z,hide:!1,valueGetter:e=>e.data},{field:"location.gps",columnGroupShow:"closed",headerName:"Meter on Map",cellRenderer:e=>s.jsx(D,{data:e,children:s.jsx(W.Provider,{value:{color:"blue",fontSize:"1rem"},children:s.jsx(K,{})})}),cellRendererParams:{modalName:"showAstOnMap",width:"3rem"},valueGetter:e=>{var n,r,i,a,d,c;const l=Number((i=(r=(n=e.data)==null?void 0:n.location)==null?void 0:r.gps)==null?void 0:i.lat),h=Number((c=(d=(a=e.data)==null?void 0:a.location)==null?void 0:d.gps)==null?void 0:c.lng);return`${l.toFixed(3)} / ${h.toFixed(3)}`},width:140},{headerName:"Meter Specific Data",children:[{field:"astData.meter.type",headerName:"Meter Type",width:150,hide:!1},{field:"astData.meter.phase",headerName:"Meter Phase",width:150,hide:!1}]},{headerName:"Anomalies",children:[{field:"anomalies.anomaly",columnGroupShow:"closed",headerName:"Anomaly",width:200},{field:"anomalies.anomalyDetail",columnGroupShow:"open",headerName:"Anomaly Detail",width:300}]},{headerName:"Meter Location",children:[{field:"location.address",columnGroupShow:"closed",headerName:"Ast Address",width:450},{field:"location.premises",columnGroupShow:"closed",headerName:"Premises",width:120},{field:"location.insideBox",columnGroupShow:"closed",headerName:"InsideBox",width:120}]},{headerName:"Keypad",children:[{field:"astData.meter.keypad.keypadAccess",columnGroupShow:"open",headerName:"Keypad Access?",width:150},{field:"astData.meter.keypad.serialNo",columnGroupShow:"open",headerName:"Keypad Serial No",width:160},{field:"astData.meter.keypad.comment",columnGroupShow:"open",headerName:"Keypad Comment",width:300}]},{headerName:"Circuit Breaker (CB)",children:[{field:"astData.meter.cb.isThereCb",columnGroupShow:"open",headerName:"CB There?",width:150},{field:"astData.meter.cb.size",columnGroupShow:"open",headerName:"CB (Amps)",width:150},{field:"astData.meter.cb.comment",columnGroupShow:"open",headerName:"CB Comment",width:300}]},{headerName:"Seal",children:[{field:"astData.meter.seal.meterSealed",columnGroupShow:"open",headerName:"Meter Sealed?",width:150},{field:"astData.meter.seal.sealNo",columnGroupShow:"open",headerName:"Seal No",width:150},{field:"astData.meter.seal.comment",columnGroupShow:"open",headerName:"Seal Comment",width:300}]},{field:"serviceConnection.configuration",columnGroupShow:"open",headerName:"Service Connection",width:300}],error:t}},Q=()=>{const{erfsContext:m,setErfsContext:t}=p.useContext(S),o=x(),{displayLMWardBoundaries:e,state:l,fitWardBoundary:h}=E(),{lmWardBoundaries:n,lmBoundary:r}=l;p.useEffect(()=>{o&&e(o)},[o,n]);const i=a=>{const d=a.currentTarget.value,c=n.find(u=>Number(u.ward)===Number(d));d==="All Wards"?(h(o,r),t({...m,ward:null})):(h(o,c.wardBoundary,c.ward),t({...m,ward:c.ward}))};return s.jsx(j,{position:g.TOP_LEFT,style:{margin:"1.6rem"},children:s.jsx("div",{className:"map-lm-ward-boundaries",children:s.jsxs("select",{onChange:i,className:"map-control-select",children:[s.jsx("option",{value:"All Wards",children:"All Wards"},"All Wards"),n&&n.map(a=>s.jsx("option",{value:a.ward,children:a.ward},a.ward))]})})})},X=m=>{const{center:t}=m,o=x(),{displayLmBoundary:e,state:l}=E(),{lmBoundary:h}=l;return p.useEffect(()=>{o&&e(o,t)},[h]),s.jsx("div",{className:"map-boundaries"})},Y=m=>{var i,a,d,c;const{erf:t,onClick:o,setMarkerRef:e}=m,l=p.useCallback(()=>o(t),[o,t]),h=p.useCallback(u=>e(u,t.id),[e,t.id]),{asts:n}=t,r=(n==null?void 0:n.length)||"";return s.jsxs(A,{position:{lat:(a=(i=t==null?void 0:t.address)==null?void 0:i.gps)==null?void 0:a.latitude,lng:(c=(d=t==null?void 0:t.address)==null?void 0:d.gps)==null?void 0:c.longitude},ref:h,onClick:l,children:[r&&s.jsx("button",{className:"erf-asts",children:r}),s.jsx("button",{className:"erf-no-btn",children:s.jsx("span",{className:"erf-no",children:t.erfNo})})]})},ee=()=>{const{erfsContext:m}=p.useContext(S),{erfs:t,ward:o}=p.useMemo(()=>m,[m]),e=t&&(t==null?void 0:t.filter(u=>{var f;return((f=u==null?void 0:u.address)==null?void 0:f.ward)===o}));console.log("erfs",e);const[l,h]=p.useState({}),[n,r]=p.useState(null),i=p.useMemo(()=>e&&n?e.find(u=>u.id===n):null,[e,n]),a=x(),d=p.useMemo(()=>a?new T({map:a,zoom:10}):null,[a]);p.useEffect(()=>{d&&(d.clearMarkers(),d.addMarkers(Object.values(l)))},[d,l]);const c=p.useCallback((u,f)=>{h(N=>{if(u&&N[f]||!u&&!N[f])return N;if(u)return{...N,[f]:u};{const{[f]:w,...M}=N;return M}})},[a]);return s.jsxs(s.Fragment,{children:[e.map((u,f)=>s.jsx(Y,{erf:u,setMarkerRef:c},u.id)),n&&s.jsx(U,{anchor:l[n],onCloseClick:()=>r(null),headerDisabled:!0,children:s.jsx("div",{children:s.jsx(q,{data:{data:i}})})})]})},te=m=>{var d,c;const{ast:t,onClick:o,setMarkerRef:e}=m,{lat:l,lng:h}=(d=t==null?void 0:t.location)==null?void 0:d.gps,n=p.useCallback(()=>o(t),[o,t]),r=p.useCallback(u=>{if(e)return e(u,t.id)},[e,t.id]),{trns:i}=t,a=(i==null?void 0:i.length)||"";return s.jsxs(A,{position:{lat:Number(l),lng:Number(h)},ref:r,onClick:n,children:[a&&s.jsx("button",{className:"ast-asts",children:a}),s.jsx("button",{className:"ast-no-btn",children:s.jsx("span",{className:"ast-no",children:(c=t==null?void 0:t.astData)==null?void 0:c.astNo})})]})},ae=m=>{const{asts:t}=m,[o,e]=p.useState({}),[l,h]=p.useState(null);p.useMemo(()=>t&&l?t.find(a=>a.id===l):null,[t,l]);const n=x(),r=p.useMemo(()=>n?new T({map:n,zoom:10}):null,[n]);p.useEffect(()=>{r&&(r.clearMarkers(),r.addMarkers(Object.values(o)))},[r,o]);const i=p.useCallback((a,d)=>{e(c=>{if(a&&c[d]||!a&&!c[d])return c;if(a)return{...c,[d]:a};{const{[d]:u,...f}=c;return f}})},[]);return s.jsx(s.Fragment,{children:t==null?void 0:t.map((a,d)=>s.jsx(te,{ast:a,setMarkerRef:i},a.id))})},se=m=>{const{asts:t}=m,o=x(),e=t&&(t==null?void 0:t.map(r=>{var i,a;return{value:(i=r==null?void 0:r.astData)==null?void 0:i.astNo,label:(a=r==null?void 0:r.astData)==null?void 0:a.astNo,data:r}})),l=r=>{var i,a,d,c,u,f;o&&r&&(o.panTo({lat:Number((d=(a=(i=r.data)==null?void 0:i.location)==null?void 0:a.gps)==null?void 0:d.lat),lng:Number((f=(u=(c=r.data)==null?void 0:c.location)==null?void 0:u.gps)==null?void 0:f.lng)}),o.setZoom(20))},h=r=>null,n={control:r=>({...r,backgroundColor:"lightgray",padding:"0.11rem"}),option:(r,i)=>({...r,borderBottom:"1px dotted pink",color:i.isSelected?"white":"black",backgroundColor:i.isSelected?"hotpink":"white"})};return s.jsx(j,{position:g.LEFT_TOP,style:{margin:"1.6rem"},children:s.jsxs("div",{className:"map-ast-filter",children:[s.jsx("div",{className:"maf",children:s.jsx("h2",{children:"Mn"})}),s.jsx(B,{defaultValue:"Meter No",options:e,isClearable:!0,onChange:l,clearValue:h,styles:n})]})})},re=()=>{const m=x(),{erfsContext:t}=p.useContext(S),{erfs:o,ward:e}=p.useMemo(()=>t,[t]),l=o&&(o==null?void 0:o.filter(a=>{var d;return((d=a==null?void 0:a.address)==null?void 0:d.ward)===e}));console.log("erfs",l);const h=l&&l.map(a=>({value:a.erfNo,label:a.erfNo,data:a})),n=a=>{var d,c,u,f,N,w;console.log("selection",a),m&&a&&(m.panTo({lat:Number((u=(c=(d=a.data)==null?void 0:d.address)==null?void 0:c.gps)==null?void 0:u.latitude),lng:Number((w=(N=(f=a.data)==null?void 0:f.address)==null?void 0:N.gps)==null?void 0:w.longitude)}),m.setZoom(20))},r=a=>(console.log("clearing selected value",a),null),i={control:a=>({...a,backgroundColor:"lightgray",padding:"0.15rem"}),option:(a,d)=>({...a,borderBottom:"1px dotted pink",color:d.isSelected?"white":"black",backgroundColor:d.isSelected?"hotpink":"white"})};return s.jsx(j,{position:g.LEFT_TOP,style:{margin:"1.6rem"},children:s.jsxs("div",{className:"map-erf-filter",children:[s.jsx("div",{className:"mef",children:s.jsx("h2",{children:"Erf"})}),s.jsx(B,{defaultValue:"Erf No",options:h,isClearable:!0,onChange:n,clearValue:r,styles:i})]})})},oe=m=>{const{asts:t,astsTableFields:o}=m;return s.jsx("div",{className:"map-main",children:s.jsxs(I,{children:[s.jsx(Q,{}),s.jsx(X,{center:"center"}),s.jsx(ae,{asts:t,astsTableFields:o}),s.jsx(ee,{}),s.jsx(se,{asts:t,astsTableFields:o}),s.jsx(re,{})]})})},de=m=>{const{phLl:t}=m,{user:o}=k(),{userFromUsers:e}=_(o==null?void 0:o.uid);return s.jsxs("div",{className:"map-header",children:[s.jsx("div",{className:"ph ph-left",children:s.jsxs("div",{className:"phLl",children:[s.jsx(G,{title:t}),s.jsx(G,{title:e.workbase})]})}),s.jsxs("div",{className:"ph ph-right",children:[s.jsx("div",{className:"phRl"}),s.jsx("div",{className:"phRr"})]})]})},we=()=>{V();const{asts:m,astsTableFields:t,error:o}=J();return s.jsxs("div",{className:"map",children:[s.jsx(de,{phLl:"Map"}),s.jsx("div",{className:"map-body",children:s.jsx(oe,{asts:m,astsTableFields:t})})]})};export{we as default};
