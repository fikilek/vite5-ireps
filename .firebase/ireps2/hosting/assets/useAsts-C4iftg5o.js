import{h as $,r as F,A as Q,i as V,u as X,w as W,q as Y,e as Z,o as w,c as ee,d as te,f as ae,k as H,l as _,j as g,m as J,n as P,I as de,p as ne}from"./index-2DC40iBv.js";import{u as re}from"./useTrns-RyE2jCXL.js";import{T as oe}from"./TableBtnsPossibleTrnsOnAst-DbbmcL6C.js";const ie=()=>({getAstsUsersStats:t=>{var r;const d={};t==null||t.forEach(a=>{d[a.metadata.createdByUid]=1+(d[a.metadata.createdByUid]||0)});const e=[];for(const a in d){const o=t==null?void 0:t.find(c=>{var h;return((h=c==null?void 0:c.metadata)==null?void 0:h.createdByUid)===a}),l=(d[a]/(t==null?void 0:t.length)*100).toFixed(2);e.push({uid:a,displayName:(r=o==null?void 0:o.metadata)==null?void 0:r.createdByUser,quantity:d[a],percentage:l,fillColor:$()})}return{stats:e,total:t==null?void 0:t.length}},getMeterTypePerUserStats:t=>{var c,h;const d=t.filter(i=>i.astData.meter.type==="pre-paid"),e={};d==null||d.forEach(i=>{e[i.metadata.createdByUid]=1+(e[i.metadata.createdByUid]||0)});const r=[];for(const i in e){const f=d==null?void 0:d.find(n=>{var m;return((m=n==null?void 0:n.metadata)==null?void 0:m.createdByUid)===i}),s=(e[i]/(d==null?void 0:d.length)*100).toFixed(2);r.push({uid:i,displayName:(c=f==null?void 0:f.metadata)==null?void 0:c.createdByUser,quantity:e[i],percentage:s,fillColor:$()})}const a=t.filter(i=>i.astData.meter.type==="conventional"),o={};a==null||a.forEach(i=>{o[i.metadata.createdByUid]=1+(o[i.metadata.createdByUid]||0)});const l=[];for(const i in o){const f=a==null?void 0:a.find(n=>{var m;return((m=n==null?void 0:n.metadata)==null?void 0:m.createdByUid)===i}),s=(o[i]/(a==null?void 0:a.length)*100).toFixed(2);l.push({uid:i,displayName:(h=f==null?void 0:f.metadata)==null?void 0:h.createdByUser,quantity:o[i],percentage:s,fillColor:$()})}return[{meterTypeName:"pre-paid",stats:r,total:d==null?void 0:d.length},{meterTypeName:"conventional",stats:l,total:a.length}]},getAnomalyPerUserStats:t=>{const d={};t==null||t.forEach(a=>{var o,l;d[(o=a==null?void 0:a.anomalies)==null?void 0:o.anomaly]=1+(d[(l=a==null?void 0:a.anomalies)==null?void 0:l.anomaly]||0)});const e=Object.entries(d);let r=[];return e==null||e.forEach(a=>{var f;const o=a[0],l=a[1],c=t==null?void 0:t.filter(s=>{var n;return((n=s==null?void 0:s.anomalies)==null?void 0:n.anomaly)===o}),h={};c==null||c.forEach(s=>{var n,m;h[(n=s==null?void 0:s.anomalies)==null?void 0:n.anomalyDetail]=1+(h[(m=s==null?void 0:s.anomalies)==null?void 0:m.anomalyDetail]||0)});const i=[];for(const s in h){const n=t==null?void 0:t.filter(u=>{var y;return((y=u==null?void 0:u.anomalies)==null?void 0:y.anomalyDetail)===s}),m={};n==null||n.forEach(u=>{m[u.metadata.createdByUid]=1+(m[u.metadata.createdByUid]||0)});const S=[];for(const u in m){const y=n==null?void 0:n.find(N=>{var D;return((D=N==null?void 0:N.metadata)==null?void 0:D.createdByUid)===u}),p=(m[u]/(t==null?void 0:t.length)*100).toFixed(2);S.push({uid:u,displayName:(f=y==null?void 0:y.metadata)==null?void 0:f.createdByUser,quantity:m[u],percentage:p,fillColor:$()})}i.push({anomalyDetailName:s,anomalyDetailStats:n.length,updatedUserStats:S})}r.push({anomalyName:o,anomalyStats:l,anomalyDetailStatsArray:i})}),{stats:r,total:t.length}}}),se=j=>{const{astsContext:q,setAstsContext:O}=F.useContext(Q),{astsStatsContext:t,setAstsStatsContext:d}=F.useContext(V),[e,r]=F.useState([]),[a,o]=F.useState(""),{getDocument:l}=re("users"),{user:c}=X(),{getAstsUsersStats:h,getMeterTypePerUserStats:i,getAnomalyPerUserStats:f}=ie(),s=c==null?void 0:c.uid;return F.useEffect(()=>{l(s).then(n=>{const{workbase:m}=n==null?void 0:n.doc,S=W("erf.address.lmMetro","==",m);if(!S)return;const u=Y(ee(te,j),w(S,W("astData.astState.state","==","stores")),Z("metadata.updatedAtDatetime","desc"));o(""),ae(u,y=>{const p=[];y.docs.forEach(M=>{p.push({id:M.id,...M.data()})}),r(p);const N=h(p),D=i(p),U=f(p);O({...q,asts:p}),d(M=>({...M,statsAstsUsers:N,meterTypePerUserStats:D,anomalyPerUserStats:U}))},y=>{console.log("firestore err",y.message),o(y.message)}),o("")})},[]),{asts:e,error:a}},he=()=>{const{error:j}=se("asts");return{astsTableFields:[{field:"id",headerName:"System Id",width:200,hide:!0},{headerName:"Created",children:[{field:"metadata.createdByUser",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:160,cellRenderer:t=>{var r,a;const d=new H((r=t==null?void 0:t.value)==null?void 0:r.seconds,(a=t==null?void 0:t.value)==null?void 0:a.nanoseconds),e=d==null?void 0:d.toDate();return g.jsx(J,{date:e,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:t=>{var d,e;return(e=(d=t.data)==null?void 0:d.metadata)==null?void 0:e.createdAtDatetime},hide:!1}]},{headerName:"Last Updated",children:[{field:"metadata.updatedByUser",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedAtDatetime",columnGroupShow:"open",headerName:"Date Updated",width:160,cellRenderer:t=>{const e=new H(t.value.seconds,t.value.nanoseconds).toDate();return g.jsx(J,{date:e,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:t=>t.data.metadata.updatedAtDatetime,hide:!1}]},{field:"erf.erfNo",headerName:"Erf No",width:100,tooltipField:"Erf the ast belong to"},{field:"erf.address.ward",headerName:"Ward",width:100},{headerName:"Meter Description",children:[{field:"astData.astNo",headerName:"Meter No",width:170,columnGroupShow:"closed",cellRenderer:t=>g.jsx(P,{data:t,children:t.value}),cellRendererParams:{modalName:"meterReport",width:"8rem",irepsKeyItem:"asts",displayMode:"modal"},hide:!1},{field:"astData.astCatergory",headerName:"Catergory",columnGroupShow:"open",width:150,hide:!0},{field:"astData.astManufacturer",headerName:"Manufacturer (Brand)",columnGroupShow:"open",width:200,hide:!1},{field:"astData.astName",headerName:"Ast Technical Name",columnGroupShow:"open",width:150,hide:!1},{field:"astData.astState",headerName:"State",columnGroupShow:"open",width:150,hide:!1}]},{field:"",headerName:"Meter Media",width:150,cellRenderer:t=>g.jsx(P,{data:t,children:t.value}),cellRendererParams:{modalName:"mediaMobileAsts",width:"4rem",irepsKeyItem:"asts",displayMode:"modal"},valueGetter:t=>{var e,r,a,o;return(r=(e=t==null?void 0:t.data)==null?void 0:e.media)!=null&&r.length?(o=(a=t==null?void 0:t.data)==null?void 0:a.media)==null?void 0:o.length:0}},{field:"trns",headerName:"Trns On Meter",width:130,cellRenderer:oe,cellRendererParams:{columnName:"tidTrn"},hide:!1,valueGetter:t=>t.data,filter:!1},{field:"location.gps",columnGroupShow:"closed",headerName:"Meter on Map",cellRenderer:t=>g.jsx(P,{data:t,children:g.jsx(de.Provider,{value:{color:"blue",fontSize:"1rem"},children:g.jsx(ne,{})})}),cellRendererParams:{modalName:"showAstOnMap",width:"3rem"},valueGetter:t=>{var r,a,o,l,c,h;const d=Number((o=(a=(r=t.data)==null?void 0:r.location)==null?void 0:a.gps)==null?void 0:o.lat),e=Number((h=(c=(l=t.data)==null?void 0:l.location)==null?void 0:c.gps)==null?void 0:h.lng);return`${d.toFixed(3)} / ${e.toFixed(3)}`},width:140,filter:!1},{field:"astData.astState.state",headerName:"Meter State",width:250,valueGetter:t=>{var e,r,a,o,l,c,h,i,f,s,n,m,S,u,y,p,N,D,U,M,C,B,x,G,T,v,A,b,R,E;let d="";return((e=t.data)==null?void 0:e.astData.astState.state)==="stores"&&(d=`${(o=(a=(r=t.data)==null?void 0:r.astData)==null?void 0:a.astState)==null?void 0:o.state} : ${(h=(c=(l=t.data)==null?void 0:l.astData)==null?void 0:c.astState)==null?void 0:h.location}`),((i=t.data)==null?void 0:i.astData.astState.state)==="service"&&(d=`service : ${(n=(s=(f=t.data)==null?void 0:f.erf)==null?void 0:s.address)==null?void 0:n.lmMetro} - ${(m=t.data)==null?void 0:m.erf.erfNo}`),((y=(u=(S=t.data)==null?void 0:S.astData)==null?void 0:u.astState)==null?void 0:y.state)==="temper"&&(d=`temper : ${(p=t.data)==null?void 0:p.erf.address.lmMetro} - ${(N=t.data)==null?void 0:N.erf.erfNo}`),(((M=(U=(D=t.data)==null?void 0:D.astData)==null?void 0:U.astState)==null?void 0:M.state)==""||((x=(B=(C=t.data)==null?void 0:C.astData)==null?void 0:B.astState)==null?void 0:x.state)==null||((v=(T=(G=t.data)==null?void 0:G.astData)==null?void 0:T.astState)==null?void 0:v.state)==null)&&(d=`service : ${(R=(b=(A=t.data)==null?void 0:A.erf)==null?void 0:b.address)==null?void 0:R.lmMetro} - ${(E=t.data)==null?void 0:E.erf.erfNo}`),d}},{field:"metadata.createdThrough.creatorTrnName",headerName:"Meter Creator",width:140},{headerName:"Meter Specific Data",children:[{field:"astData.meter.type",headerName:"Meter Type",width:150,hide:!1},{field:"astData.meter.phase",headerName:"Meter Phase",width:150,hide:!1}]},{headerName:"Anomalies",children:[{field:"anomalies.anomaly",headerName:"Anomaly",width:200},{field:"anomalies.anomalyDetail",columnGroupShow:"open",headerName:"Anomaly Detail",width:300}]},{headerName:"Meter Location",children:[{field:"location.address",columnGroupShow:"closed",headerName:"Ast Address",width:450},{field:"location.placement",columnGroupShow:"closed",headerName:"Placement",width:190}]},{headerName:"Circuit Breaker (CB)",children:[{field:"astData.meter.cb.size",columnGroupShow:"open",headerName:"CB (Amps)",width:150},{field:"astData.meter.cb.comment",columnGroupShow:"open",headerName:"CB Comment",width:300}]},{headerName:"Seal",children:[{field:"astData.meter.seal.sealNo",columnGroupShow:"open",headerName:"Seal No",width:150},{field:"astData.meter.seal.comment",columnGroupShow:"open",headerName:"Seal Comment",width:300}]},{field:"serviceConnection.configuration",headerName:"Service Connection",width:300},{field:"serviceConnection.offGridSupply",headerName:"Off Grid Supply",width:300},{field:"tid.status",headerName:"Tid Status",width:300},{field:"tid.statusComment",headerName:"Tid Status Comment",width:300}],createExportRowData:t=>(t==null?void 0:t.length)<1?void 0:t&&(t==null?void 0:t.map(e=>{var f,s,n,m,S,u,y,p,N,D,U,M,C,B,x,G,T,v,A,b,R,E,I,L,k,z,K;const r=e.metadata.createdAtDatetime;console.log("createdAt",r);const a=new H(r==null?void 0:r.seconds,r==null?void 0:r.nanoseconds),o=a==null?void 0:a.toDate(),l=e.metadata.updatedAtDatetime,c=new H(l==null?void 0:l.seconds,l==null?void 0:l.nanoseconds),h=c==null?void 0:c.toDate();return{id:e.id,"Created By":e.metadata.createdByUser,"Created At":_(o,"yy-MM-dd HH:mm"),"Last Updated By":e.metadata.updatedByUser,"Last Updated At Datetime":_(h,"yy-MM-dd HH:mm"),"Meter No":(f=e==null?void 0:e.astData)==null?void 0:f.astNo,"Meter Manufacturer":(s=e==null?void 0:e.astData)==null?void 0:s.astManufacturer,"Meter Name":(n=e==null?void 0:e.astData)==null?void 0:n.astName,"Meter Type":(S=(m=e==null?void 0:e.astData)==null?void 0:m.meter)==null?void 0:S.type,"Meter Phase":(y=(u=e==null?void 0:e.astData)==null?void 0:u.meter)==null?void 0:y.phase,"CB Size":(D=(N=(p=e==null?void 0:e.astData)==null?void 0:p.meter)==null?void 0:N.cb)==null?void 0:D.size,"Seal Number":(C=(M=(U=e==null?void 0:e.astData)==null?void 0:U.meter)==null?void 0:M.seal)==null?void 0:C.sealNo,Anomaly:(B=e==null?void 0:e.anomalies)==null?void 0:B.anomaly,"Anomaly Detail":(x=e==null?void 0:e.anomalies)==null?void 0:x.anomalyDetail,"Erf No":(G=e==null?void 0:e.erf)==null?void 0:G.erfNo,"Street Adr":(T=e==null?void 0:e.erf)==null?void 0:T.street,"Property Type":(A=(v=e==null?void 0:e.erf)==null?void 0:v.propertyType)==null?void 0:A.type,"Unit Name":(R=(b=e==null?void 0:e.erf)==null?void 0:b.propertyType)==null?void 0:R.unitName,"Unit No":(I=(E=e==null?void 0:e.erf)==null?void 0:E.propertyType)==null?void 0:I.unitNo,"Meter Location":(L=e==null?void 0:e.location)==null?void 0:L.placement,"Meter Address":(k=e==null?void 0:e.location)==null?void 0:k.address,"Service Connection Status":(z=e==null?void 0:e.serviceConnection)==null?void 0:z.configuration,"Off Grid Supply":(K=e==null?void 0:e.serviceConnection)==null?void 0:K.offGridSupply}})),error:j}};export{ie as a,he as u};
