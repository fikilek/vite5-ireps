import{h as O,r as H,A as de,i as ne,u as re,w as ee,q as se,e as ie,o as oe,c as le,d as ce,f as me,k as q,l as te,j as B,m as ae,n as I,I as ue,p as he}from"./index-DTpsEHRa.js";import{u as fe}from"./useTrns-u3hDq8uc.js";import{T as pe}from"./TableBtnsPossibleTrnsOnAst-BG1CvRs6.js";const ye=()=>({getAstsUsersStats:t=>{var s;const d={};t==null||t.forEach(a=>{d[a.metadata.createdByUid]=1+(d[a.metadata.createdByUid]||0)});const e=[];for(const a in d){const n=t==null?void 0:t.find(o=>{var m;return((m=o==null?void 0:o.metadata)==null?void 0:m.createdByUid)===a}),u=(d[a]/(t==null?void 0:t.length)*100).toFixed(2);e.push({uid:a,displayName:(s=n==null?void 0:n.metadata)==null?void 0:s.createdByUser,quantity:d[a],percentage:u,fillColor:O()})}return{stats:e,total:t==null?void 0:t.length}},getMeterTypePerUserStats:t=>{var o,m;const d=t.filter(i=>i.astData.meter.type==="pre-paid"),e={};d==null||d.forEach(i=>{e[i.metadata.createdByUid]=1+(e[i.metadata.createdByUid]||0)});const s=[];for(const i in e){const p=d==null?void 0:d.find(r=>{var c;return((c=r==null?void 0:r.metadata)==null?void 0:c.createdByUid)===i}),l=(e[i]/(d==null?void 0:d.length)*100).toFixed(2);s.push({uid:i,displayName:(o=p==null?void 0:p.metadata)==null?void 0:o.createdByUser,quantity:e[i],percentage:l,fillColor:O()})}const a=t.filter(i=>i.astData.meter.type==="conventional"),n={};a==null||a.forEach(i=>{n[i.metadata.createdByUid]=1+(n[i.metadata.createdByUid]||0)});const u=[];for(const i in n){const p=a==null?void 0:a.find(r=>{var c;return((c=r==null?void 0:r.metadata)==null?void 0:c.createdByUid)===i}),l=(n[i]/(a==null?void 0:a.length)*100).toFixed(2);u.push({uid:i,displayName:(m=p==null?void 0:p.metadata)==null?void 0:m.createdByUser,quantity:n[i],percentage:l,fillColor:O()})}return[{meterTypeName:"pre-paid",stats:s,total:d==null?void 0:d.length},{meterTypeName:"conventional",stats:u,total:a.length}]},getAnomalyPerUserStats:t=>{const d={};t==null||t.forEach(a=>{var n,u;d[(n=a==null?void 0:a.anomalies)==null?void 0:n.anomaly]=1+(d[(u=a==null?void 0:a.anomalies)==null?void 0:u.anomaly]||0)});const e=Object.entries(d);let s=[];return e==null||e.forEach(a=>{var p;const n=a[0],u=a[1],o=t==null?void 0:t.filter(l=>{var r;return((r=l==null?void 0:l.anomalies)==null?void 0:r.anomaly)===n}),m={};o==null||o.forEach(l=>{var r,c;m[(r=l==null?void 0:l.anomalies)==null?void 0:r.anomalyDetail]=1+(m[(c=l==null?void 0:l.anomalies)==null?void 0:c.anomalyDetail]||0)});const i=[];for(const l in m){const r=t==null?void 0:t.filter(h=>{var f;return((f=h==null?void 0:h.anomalies)==null?void 0:f.anomalyDetail)===l}),c={};r==null||r.forEach(h=>{c[h.metadata.createdByUid]=1+(c[h.metadata.createdByUid]||0)});const S=[];for(const h in c){const f=r==null?void 0:r.find(N=>{var D;return((D=N==null?void 0:N.metadata)==null?void 0:D.createdByUid)===h}),y=(c[h]/(t==null?void 0:t.length)*100).toFixed(2);S.push({uid:h,displayName:(p=f==null?void 0:f.metadata)==null?void 0:p.createdByUser,quantity:c[h],percentage:y,fillColor:O()})}i.push({anomalyDetailName:l,anomalyDetailStats:r.length,updatedUserStats:S})}s.push({anomalyName:n,anomalyStats:u,anomalyDetailStatsArray:i})}),{stats:s,total:t.length}}}),Se=U=>{const{astsContext:G,setAstsContext:g}=H.useContext(de),{astsStatsContext:t,setAstsStatsContext:d}=H.useContext(ne),[e,s]=H.useState([]),[a,n]=H.useState(""),{getDocument:u}=fe("users"),{user:o}=re(),{getAstsUsersStats:m,getMeterTypePerUserStats:i,getAnomalyPerUserStats:p}=ye(),l=o==null?void 0:o.uid;return H.useEffect(()=>{u(l).then(r=>{const{workbase:c}=r==null?void 0:r.doc,S=ee("erf.address.lmMetro","==",c);if(!S)return;const h=se(le(ce,U),oe(S,ee("astData.astState.state","==","stores")),ie("metadata.updatedAtDatetime","desc"));n(""),me(h,f=>{const y=[];f.docs.forEach(M=>{y.push({id:M.id,...M.data()})}),s(y);const N=m(y),D=i(y),C=p(y);g({...G,asts:y}),d(M=>({...M,statsAstsUsers:N,meterTypePerUserStats:D,anomalyPerUserStats:C}))},f=>{console.log("firestore err",f.message),n(f.message)}),n("")})},[]),{asts:e,error:a}},x=(U,G)=>{const g=U==null?void 0:U.find(d=>(d==null?void 0:d.mediaCategory)===G);return g==null?void 0:g.url},Ue=()=>{const{error:U}=Se("asts");return{astsTableFields:[{field:"id",headerName:"System Id",width:200,hide:!0},{headerName:"Created",children:[{field:"metadata.createdByUser",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:160,cellRenderer:t=>{var s,a;const d=new q((s=t==null?void 0:t.value)==null?void 0:s.seconds,(a=t==null?void 0:t.value)==null?void 0:a.nanoseconds),e=d==null?void 0:d.toDate();return B.jsx(ae,{date:e,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:t=>{var d,e;return(e=(d=t.data)==null?void 0:d.metadata)==null?void 0:e.createdAtDatetime},hide:!1}]},{headerName:"Last Updated",children:[{field:"metadata.updatedByUser",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedAtDatetime",columnGroupShow:"open",headerName:"Date Updated",width:160,cellRenderer:t=>{const e=new q(t.value.seconds,t.value.nanoseconds).toDate();return B.jsx(ae,{date:e,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:t=>t.data.metadata.updatedAtDatetime,hide:!1}]},{field:"erf.erfNo",headerName:"Erf No",width:100,tooltipField:"Erf the ast belong to"},{field:"erf.address.ward",headerName:"Ward",width:100},{headerName:"Meter Description",children:[{field:"astData.astNo",headerName:"Meter No",width:170,columnGroupShow:"closed",cellRenderer:t=>B.jsx(I,{data:t,children:t.value}),cellRendererParams:{modalName:"meterReport",width:"8rem",irepsKeyItem:"asts",displayMode:"modal"},hide:!1},{field:"astData.astCatergory",headerName:"Catergory",columnGroupShow:"open",width:150,hide:!0},{field:"astData.astManufacturer",headerName:"Manufacturer (Brand)",columnGroupShow:"open",width:200,hide:!1},{field:"astData.astName",headerName:"Ast Technical Name",columnGroupShow:"open",width:150,hide:!1},{field:"astData.astState",headerName:"State",columnGroupShow:"open",width:150,hide:!1}]},{field:"",headerName:"Meter Media",width:150,cellRenderer:t=>B.jsx(I,{data:t,children:t.value}),cellRendererParams:{modalName:"mediaMobileAsts",width:"4rem",irepsKeyItem:"asts",displayMode:"modal"},valueGetter:t=>{var e,s,a,n;return(s=(e=t==null?void 0:t.data)==null?void 0:e.media)!=null&&s.length?(n=(a=t==null?void 0:t.data)==null?void 0:a.media)==null?void 0:n.length:0}},{field:"trns",headerName:"Trns On Meter",width:130,cellRenderer:pe,cellRendererParams:{columnName:"tidTrn"},hide:!1,valueGetter:t=>t.data,filter:!1},{field:"location.gps",columnGroupShow:"closed",headerName:"Meter on Map",cellRenderer:t=>B.jsx(I,{data:t,children:B.jsx(ue.Provider,{value:{color:"blue",fontSize:"1rem"},children:B.jsx(he,{})})}),cellRendererParams:{modalName:"showAstOnMap",width:"3rem"},valueGetter:t=>{var s,a,n,u,o,m;const d=Number((n=(a=(s=t.data)==null?void 0:s.location)==null?void 0:a.gps)==null?void 0:n.lat),e=Number((m=(o=(u=t.data)==null?void 0:u.location)==null?void 0:o.gps)==null?void 0:m.lng);return`${d.toFixed(3)} / ${e.toFixed(3)}`},width:140,filter:!1},{field:"astData.astState.state",headerName:"Meter State",width:250,valueGetter:t=>{var e,s,a,n,u,o,m,i,p,l,r,c,S,h,f,y,N,D,C,M,T,v,b,R,A,E,F,j,$,P;let d="";return((e=t.data)==null?void 0:e.astData.astState.state)==="stores"&&(d=`${(n=(a=(s=t.data)==null?void 0:s.astData)==null?void 0:a.astState)==null?void 0:n.state} : ${(m=(o=(u=t.data)==null?void 0:u.astData)==null?void 0:o.astState)==null?void 0:m.location}`),((i=t.data)==null?void 0:i.astData.astState.state)==="service"&&(d=`service : ${(r=(l=(p=t.data)==null?void 0:p.erf)==null?void 0:l.address)==null?void 0:r.lmMetro} - ${(c=t.data)==null?void 0:c.erf.erfNo}`),((f=(h=(S=t.data)==null?void 0:S.astData)==null?void 0:h.astState)==null?void 0:f.state)==="temper"&&(d=`temper : ${(y=t.data)==null?void 0:y.erf.address.lmMetro} - ${(N=t.data)==null?void 0:N.erf.erfNo}`),(((M=(C=(D=t.data)==null?void 0:D.astData)==null?void 0:C.astState)==null?void 0:M.state)==""||((b=(v=(T=t.data)==null?void 0:T.astData)==null?void 0:v.astState)==null?void 0:b.state)==null||((E=(A=(R=t.data)==null?void 0:R.astData)==null?void 0:A.astState)==null?void 0:E.state)==null)&&(d=`service : ${($=(j=(F=t.data)==null?void 0:F.erf)==null?void 0:j.address)==null?void 0:$.lmMetro} - ${(P=t.data)==null?void 0:P.erf.erfNo}`),d}},{field:"metadata.createdThrough.creatorTrnName",headerName:"Meter Creator",width:140},{headerName:"Meter Specific Data",children:[{field:"astData.meter.type",headerName:"Meter Type",width:150,hide:!1},{field:"astData.meter.phase",headerName:"Meter Phase",width:150,hide:!1}]},{headerName:"Anomalies",children:[{field:"anomalies.anomaly",headerName:"Anomaly",width:200},{field:"anomalies.anomalyDetail",columnGroupShow:"open",headerName:"Anomaly Detail",width:300}]},{headerName:"Meter Location",children:[{field:"location.address",columnGroupShow:"closed",headerName:"Ast Address",width:450},{field:"location.placement",columnGroupShow:"closed",headerName:"Placement",width:190}]},{headerName:"Circuit Breaker (CB)",children:[{field:"astData.meter.cb.size",columnGroupShow:"open",headerName:"CB (Amps)",width:150},{field:"astData.meter.cb.comment",columnGroupShow:"open",headerName:"CB Comment",width:300}]},{headerName:"Seal",children:[{field:"astData.meter.seal.sealNo",columnGroupShow:"open",headerName:"Seal No",width:150},{field:"astData.meter.seal.comment",columnGroupShow:"open",headerName:"Seal Comment",width:300}]},{field:"serviceConnection.configuration",headerName:"Service Connection",width:300},{field:"serviceConnection.offGridSupply",headerName:"Off Grid Supply",width:300},{field:"tid.status",headerName:"Tid Status",width:300},{field:"tid.statusComment",headerName:"Tid Status Comment",width:300}],createExportRowData:t=>(t==null?void 0:t.length)<1?void 0:t&&(t==null?void 0:t.map(e=>{var l,r,c,S,h,f,y,N,D,C,M,T,v,b,R,A,E,F,j,$,P,k,z,L,K,W,_,J,Q,V,X,Y,Z,w;const s=e==null?void 0:e.media,a=e.metadata.createdAtDatetime,n=new q(a==null?void 0:a.seconds,a==null?void 0:a.nanoseconds),u=n==null?void 0:n.toDate(),o=e.metadata.updatedAtDatetime,m=new q(o==null?void 0:o.seconds,o==null?void 0:o.nanoseconds),i=m==null?void 0:m.toDate();return{id:e.id,"Created By":e.metadata.createdByUser,"Created At":te(u,"yy-MM-dd HH:mm"),"Last Updated By":e.metadata.updatedByUser,"Last Updated At Datetime":te(i,"yy-MM-dd HH:mm"),"Meter No":(l=e==null?void 0:e.astData)==null?void 0:l.astNo,"Meter No picture":x(s,"astNo"),"Meter Manufacturer":(r=e==null?void 0:e.astData)==null?void 0:r.astManufacturer,"Meter Name":(c=e==null?void 0:e.astData)==null?void 0:c.astName,"Meter Type":(h=(S=e==null?void 0:e.astData)==null?void 0:S.meter)==null?void 0:h.type,"Meter Phase":(y=(f=e==null?void 0:e.astData)==null?void 0:f.meter)==null?void 0:y.phase,"CB Size":(C=(D=(N=e==null?void 0:e.astData)==null?void 0:N.meter)==null?void 0:D.cb)==null?void 0:C.size,"CB picture":x(s,"cb"),"CB Comment":(v=(T=(M=e==null?void 0:e.astData)==null?void 0:M.meter)==null?void 0:T.cb)==null?void 0:v.comment,"Seal Number":(A=(R=(b=e==null?void 0:e.astData)==null?void 0:b.meter)==null?void 0:R.seal)==null?void 0:A.sealNo,"Seal Number picture":x(s,"seal"),"Seal Comment":(j=(F=(E=e==null?void 0:e.astData)==null?void 0:E.meter)==null?void 0:F.seal)==null?void 0:j.comment,Anomaly:($=e==null?void 0:e.anomalies)==null?void 0:$.anomaly,"Anomaly picture":x(s,"anomaly"),"Anomaly Detail":(P=e==null?void 0:e.anomalies)==null?void 0:P.anomalyDetail,"Erf No":(k=e==null?void 0:e.erf)==null?void 0:k.erfNo,"Street Adr":(z=e==null?void 0:e.erf)==null?void 0:z.street,"Property Type":(K=(L=e==null?void 0:e.erf)==null?void 0:L.propertyType)==null?void 0:K.type,"Unit Name":(_=(W=e==null?void 0:e.erf)==null?void 0:W.propertyType)==null?void 0:_.unitName,"Unit No":(Q=(J=e==null?void 0:e.erf)==null?void 0:J.propertyType)==null?void 0:Q.unitNo,"Meter Placement":(V=e==null?void 0:e.location)==null?void 0:V.placement,"Meter Placement picture":x(s,"insideBox"),"Meter Address":(X=e==null?void 0:e.location)==null?void 0:X.address,"Service Connection Status":(Y=e==null?void 0:e.serviceConnection)==null?void 0:Y.configuration,"Off Grid Supply":(Z=e==null?void 0:e.serviceConnection)==null?void 0:Z.offGridSupply,"Off Grid picture":x(s,"offGridPhoto"),"TID Status":(w=e==null?void 0:e.tidStatus)==null?void 0:w.status,"TID Status picture":x(s,"tidStatus")}})),error:U}};export{ye as a,Ue as u};
