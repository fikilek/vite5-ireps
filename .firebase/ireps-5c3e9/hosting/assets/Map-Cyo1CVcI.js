import{r as f,u as G,q as R,e as W,w as $,c as L,d as P,f as O,k as y,j as a,m as v,n as D,I as K,p as U,E as S,s as x,M as b,C as j,t as B,v as k,S as E,x as I,a as _}from"./index-CyIbrq5N.js";import{u as H}from"./useTrns-VJPHtcEx.js";import{T as z,u as V}from"./useErfs-CrZDnWty.js";import{u as T,A as q}from"./useIrepsMap-E9da2_LW.js";import{M as F}from"./index.esm-BZQCNebo.js";import Z from"./FormErf-BuG5jBVy.js";import{P as A}from"./PageTitle-D2WKNyb8.js";import"./IwTrnsOnAst-CD6_04NO.js";import"./ag-theme-quartz-jeQqDcK2.js";import"./IrepsInfoWindow-C2Qnxqhe.js";const J=h=>{const[t,o]=f.useState([]),[e,n]=f.useState(""),{getDocument:m}=H("users"),{user:l}=G(),r=l==null?void 0:l.uid;return f.useEffect(()=>{m(r).then(d=>{const{workbase:s}=d==null?void 0:d.doc,i=R(L(P,h),$("erf.address.lmMetro","==",s),W("metadata.updatedAtDatetime","desc"));n(""),O(i,c=>{const u=[];c.docs.forEach(p=>{u.push({id:p.id,...p.data()})}),o(u)},c=>{console.log("firestore err",c.message),n(c.message)}),n("")})},[]),{asts:t,error:e}},Q=()=>{const{asts:h,error:t}=J("asts");return{asts:h,astsTableFields:[{field:"id",headerName:"System Id",width:200,hide:!0},{headerName:"Created",children:[{field:"metadata.createdByUser",columnGroupShow:"closed",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdByUser",columnGroupShow:"open",headerName:"Created By",width:150,hide:!1},{field:"metadata.createdAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:150,cellRenderer:e=>{const m=new y(e.value.seconds,e.value.nanoseconds).toDate();return a.jsx(v,{date:m,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:e=>e.data.metadata.createdAtDatetime,hide:!1}]},{headerName:"Updated",children:[{field:"metadata.updatedByUser",columnGroupShow:"closed",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedByUser",columnGroupShow:"open",headerName:"Updated By",width:150,hide:!1},{field:"metadata.updatedAtDatetime",columnGroupShow:"open",headerName:"Date Created",width:150,cellRenderer:e=>{const m=new y(e.value.seconds,e.value.nanoseconds).toDate();return a.jsx(v,{date:m,dateFormat:"yyyy-MMM-dd HH:mm"})},valueGetter:e=>e.data.metadata.updatedAtDatetime,hide:!1}]},{field:"erf.erfNo",headerName:"Erf No",width:100,tooltipField:"Erf the ast belong to"},{headerName:"Meter Description",children:[{field:"astData.astNo",headerName:"Meter No",width:170,columnGroupShow:"closed",hide:!1},{field:"astData.astCatergory",headerName:"Catergory",columnGroupShow:"open",width:150,hide:!0},{field:"astData.astManufacturer",headerName:"Manufacturer (Brand)",columnGroupShow:"open",width:200,hide:!1},{field:"astData.astName",headerName:"Ast Technical Name",columnGroupShow:"open",width:150,hide:!1},{field:"astData.astState",headerName:"State",columnGroupShow:"open",width:150,hide:!1}]},{field:"",headerName:"Meter Media",width:150,cellRenderer:e=>a.jsx(D,{data:e,children:e.value}),cellRendererParams:{modalName:"mediaMobileAsts",width:"4rem",irepsKeyItem:"asts",displayMode:"modal"},valueGetter:e=>{var m,l,r,d;return(l=(m=e==null?void 0:e.data)==null?void 0:m.media)!=null&&l.length?(d=(r=e==null?void 0:e.data)==null?void 0:r.media)==null?void 0:d.length:0}},{field:"astData.astState.state",headerName:"Meter State",width:250,valueGetter:e=>{var m,l,r,d,s,i,c,u,p,N,w,M,g,C;let n="";return((m=e.data)==null?void 0:m.astData.astState.state)==="stores"&&(n=`${(l=e.data)==null?void 0:l.astData.astState.state} : ${(r=e.data)==null?void 0:r.astData.astState.location}`),((d=e.data)==null?void 0:d.astData.astState.state)==="service"&&(n=`service : ${(s=e.data)==null?void 0:s.erf.address.lmMetro} - ${(i=e.data)==null?void 0:i.erf.erfNo}`),((c=e.data)==null?void 0:c.astData.astState.state)==="temper"&&(n=`temper : ${(u=e.data)==null?void 0:u.erf.address.lmMetro} - ${(p=e.data)==null?void 0:p.erf.erfNo}`),(((N=e.data)==null?void 0:N.astData.astState.state)==""||((w=e.data)==null?void 0:w.astData.astState.state)==null||((M=e.data)==null?void 0:M.astData.astState.state)==null)&&(n=`service : ${(g=e.data)==null?void 0:g.erf.address.lmMetro} - ${(C=e.data)==null?void 0:C.erf.erfNo}`),n}},{field:"trns",headerName:"Trns On Meter",width:320,cellRenderer:z,hide:!1,valueGetter:e=>e.data},{field:"location.gps",columnGroupShow:"closed",headerName:"Meter on Map",cellRenderer:e=>a.jsx(D,{data:e,children:a.jsx(K.Provider,{value:{color:"blue",fontSize:"1rem"},children:a.jsx(U,{})})}),cellRendererParams:{modalName:"showAstOnMap",width:"3rem"},valueGetter:e=>{var l,r,d,s,i,c;const n=Number((d=(r=(l=e.data)==null?void 0:l.location)==null?void 0:r.gps)==null?void 0:d.lat),m=Number((c=(i=(s=e.data)==null?void 0:s.location)==null?void 0:i.gps)==null?void 0:c.lng);return`${n.toFixed(3)} / ${m.toFixed(3)}`},width:140},{headerName:"Meter Specific Data",children:[{field:"astData.meter.type",headerName:"Meter Type",width:150,hide:!1},{field:"astData.meter.phase",headerName:"Meter Phase",width:150,hide:!1}]},{headerName:"Anomalies",children:[{field:"anomalies.anomaly",columnGroupShow:"closed",headerName:"Anomaly",width:200},{field:"anomalies.anomalyDetail",columnGroupShow:"open",headerName:"Anomaly Detail",width:300}]},{headerName:"Meter Location",children:[{field:"location.address",columnGroupShow:"closed",headerName:"Ast Address",width:450},{field:"location.premises",columnGroupShow:"closed",headerName:"Premises",width:120},{field:"location.insideBox",columnGroupShow:"closed",headerName:"InsideBox",width:120}]},{headerName:"Keypad",children:[{field:"astData.meter.keypad.keypadAccess",columnGroupShow:"open",headerName:"Keypad Access?",width:150},{field:"astData.meter.keypad.serialNo",columnGroupShow:"open",headerName:"Keypad Serial No",width:160},{field:"astData.meter.keypad.comment",columnGroupShow:"open",headerName:"Keypad Comment",width:300}]},{headerName:"Circuit Breaker (CB)",children:[{field:"astData.meter.cb.isThereCb",columnGroupShow:"open",headerName:"CB There?",width:150},{field:"astData.meter.cb.size",columnGroupShow:"open",headerName:"CB (Amps)",width:150},{field:"astData.meter.cb.comment",columnGroupShow:"open",headerName:"CB Comment",width:300}]},{headerName:"Seal",children:[{field:"astData.meter.seal.meterSealed",columnGroupShow:"open",headerName:"Meter Sealed?",width:150},{field:"astData.meter.seal.sealNo",columnGroupShow:"open",headerName:"Seal No",width:150},{field:"astData.meter.seal.comment",columnGroupShow:"open",headerName:"Seal Comment",width:300}]},{field:"serviceConnection.configuration",columnGroupShow:"open",headerName:"Service Connection",width:300}],error:t}},X=()=>{const{erfsContext:h,setErfsContext:t}=f.useContext(S),o=x(),{displayLMWardBoundaries:e,state:n,fitWardBoundary:m}=T(),{lmWardBoundaries:l,lmBoundary:r}=n;f.useEffect(()=>{o&&e(o)},[o,l]);const d=s=>{const i=s.currentTarget.value;console.log("selectedWard",i);const c=l.find(u=>Number(u.ward)===Number(i));i==="All Wards"?(m(o,r),t({...h,ward:null})):(m(o,c.wardBoundary,c.ward),t({...h,ward:c.ward}))};return a.jsx(b,{position:j.TOP_LEFT,style:{margin:"1.6rem"},children:a.jsx("div",{className:"map-lm-ward-boundaries",children:a.jsxs("select",{onChange:d,className:"map-control-select",children:[a.jsx("option",{value:"All Wards",children:"All Wards"},"All Wards"),l&&l.map(s=>a.jsx("option",{value:s.ward,children:s.ward},s.ward))]})})})},Y=h=>{const{center:t}=h,o=x(),{displayLmBoundary:e,state:n}=T(),{lmBoundary:m}=n;return f.useEffect(()=>{o&&e(o,t)},[m]),a.jsx("div",{className:"map-boundaries"})},ee=h=>{var r,d,s,i;const{erf:t,onClick:o,setMarkerRef:e}=h;f.useCallback(()=>o(t),[o,t]);const n=f.useCallback(c=>e(c,t.id),[e,t==null?void 0:t.id]),{asts:m}=t,l=(m==null?void 0:m.length)||"";return a.jsxs(B,{position:{lat:(d=(r=t==null?void 0:t.address)==null?void 0:r.gps)==null?void 0:d.latitude,lng:(i=(s=t==null?void 0:t.address)==null?void 0:s.gps)==null?void 0:i.longitude},ref:n,children:[l&&a.jsx("button",{className:"erf-asts",children:l}),a.jsx("button",{className:"erf-no-btn",children:a.jsx("span",{className:"erf-no",children:t==null?void 0:t.erfNo})})]})},te=()=>{const{erfsContext:h}=f.useContext(S),{erfs:t,ward:o}=f.useMemo(()=>h,[h]),e=t&&(t==null?void 0:t.filter(u=>{var p;return Number((p=u==null?void 0:u.address)==null?void 0:p.ward)===Number(o)})),[n,m]=f.useState({}),[l,r]=f.useState(null),d=f.useMemo(()=>e&&l?e.find(u=>u.id===l):null,[e,l]),s=x(),i=f.useMemo(()=>s?new F({map:s,zoom:10}):null,[s]);f.useEffect(()=>{i&&(i.clearMarkers(),i.addMarkers(Object.values(n)))},[i,n]);const c=f.useCallback((u,p)=>{m(N=>{if(u&&N[p]||!u&&!N[p])return N;if(u)return{...N,[p]:u};{const{[p]:w,...M}=N;return M}})},[s]);return a.jsxs("div",{className:"clustered-erf-markers",children:[e.map((u,p)=>a.jsx(ee,{erf:u,setMarkerRef:c},u.id)),l&&a.jsx(k,{anchor:n[l],disableAutoPan:!0,headerDisabled:!0,maxWidth:"100vw",children:a.jsx("div",{className:"iw-erf-form",children:a.jsx(Z,{data:{data:d}})})})]})},ae=h=>{var s,i;const{ast:t,onClick:o,setMarkerRef:e}=h,{lat:n,lng:m}=(s=t==null?void 0:t.location)==null?void 0:s.gps;f.useCallback(()=>o(t),[o,t]);const l=f.useCallback(c=>{if(e)return e(c,t.id)},[e,t.id]),{trns:r}=t,d=(r==null?void 0:r.length)||"";return a.jsxs(B,{position:{lat:Number(n),lng:Number(m)},ref:l,children:[d&&a.jsx("button",{className:"ast-asts",children:d}),a.jsx("button",{className:"ast-no-btn",children:a.jsx("span",{className:"ast-no",children:(i=t==null?void 0:t.astData)==null?void 0:i.astNo})})]})},se=h=>{var i;const{asts:t}=h,[o,e]=f.useState({}),[n,m]=f.useState(null),l=f.useMemo(()=>t&&n?t.find(c=>c.id===n):null,[t,n]),r=x(),d=f.useMemo(()=>r?new F({map:r,zoom:10}):null,[r]);f.useEffect(()=>{d&&(d.clearMarkers(),d.addMarkers(Object.values(o)))},[d,o]);const s=f.useCallback((c,u)=>{e(p=>{if(c&&p[u]||!c&&!p[u])return p;if(c)return{...p,[u]:c};{const{[u]:N,...w}=p;return w}})},[]);return a.jsxs(a.Fragment,{children:[t==null?void 0:t.map((c,u)=>a.jsx(ae,{ast:c,setMarkerRef:s},c.id)),n&&a.jsx(k,{anchor:o[n],onClose:()=>m(null),headerContent:`Meter No: ${(i=l==null?void 0:l.astData)==null?void 0:i.astNo}`,headerDisabled:!0,children:a.jsx("div",{children:a.jsx(q,{data:{data:l}})})})]})},re=h=>{const{asts:t}=h,o=x(),e=t&&(t==null?void 0:t.map(r=>{var d,s;return{value:(d=r==null?void 0:r.astData)==null?void 0:d.astNo,label:(s=r==null?void 0:r.astData)==null?void 0:s.astNo,data:r}})),n=r=>{var d,s,i,c,u,p;o&&r&&(o.panTo({lat:Number((i=(s=(d=r.data)==null?void 0:d.location)==null?void 0:s.gps)==null?void 0:i.lat),lng:Number((p=(u=(c=r.data)==null?void 0:c.location)==null?void 0:u.gps)==null?void 0:p.lng)}),o.setZoom(20))},m=r=>null,l={control:r=>({...r,backgroundColor:"lightgray",padding:"0.11rem"}),option:(r,d)=>({...r,borderBottom:"1px dotted pink",color:d.isSelected?"white":"black",backgroundColor:d.isSelected?"hotpink":"white"})};return a.jsx(b,{position:j.LEFT_TOP,style:{margin:"1.6rem"},children:a.jsxs("div",{className:"map-ast-filter",children:[a.jsx("div",{className:"maf",children:a.jsx("h2",{children:"Mn"})}),a.jsx(E,{defaultValue:"Meter No",options:e,isClearable:!0,onChange:n,clearValue:m,styles:l})]})})},oe=()=>{const h=x(),{erfsContext:t}=f.useContext(S),{erfs:o,ward:e}=f.useMemo(()=>t,[t]),n=o&&(o==null?void 0:o.filter(s=>{var i;return Number((i=s==null?void 0:s.address)==null?void 0:i.ward)===Number(e)})),m=n&&n.map(s=>({value:s.erfNo,label:s.erfNo,data:s})),l=s=>{var i,c,u,p,N,w;h&&s&&(h.panTo({lat:Number((u=(c=(i=s.data)==null?void 0:i.address)==null?void 0:c.gps)==null?void 0:u.latitude),lng:Number((w=(N=(p=s.data)==null?void 0:p.address)==null?void 0:N.gps)==null?void 0:w.longitude)}),h.setZoom(20))},r=s=>(console.log("clearing selected value",s),null),d={control:s=>({...s,backgroundColor:"lightgray",padding:"0.15rem"}),option:(s,i)=>({...s,borderBottom:"1px dotted pink",color:i.isSelected?"white":"black",backgroundColor:i.isSelected?"hotpink":"white"})};return a.jsx(b,{position:j.LEFT_TOP,style:{margin:"1.6rem"},children:a.jsxs("div",{className:"map-erf-filter",children:[a.jsx("div",{className:"mef",children:a.jsx("h2",{children:"Erf"})}),a.jsx(E,{defaultValue:"Erf No",options:m,isClearable:!0,onChange:l,clearValue:r,styles:d})]})})},de=h=>{const{asts:t,astsTableFields:o}=h;return a.jsx("div",{className:"map-main",children:a.jsxs(I,{children:[a.jsx(X,{}),a.jsx(Y,{center:"center"}),a.jsx(se,{asts:t,astsTableFields:o}),a.jsx(te,{}),a.jsx(re,{asts:t,astsTableFields:o}),a.jsx(oe,{})]})})},ne=h=>{const{phLl:t}=h,{user:o}=G(),{userFromUsers:e}=_(o==null?void 0:o.uid);return a.jsxs("div",{className:"map-header",children:[a.jsx("div",{className:"ph ph-left",children:a.jsxs("div",{className:"phLl",children:[a.jsx(A,{title:t}),a.jsx(A,{title:e.workbase})]})}),a.jsxs("div",{className:"ph ph-right",children:[a.jsx("div",{className:"phRl"}),a.jsx("div",{className:"phRr"})]})]})},xe=()=>{V();const{asts:h,astsTableFields:t,error:o}=Q();return a.jsxs("div",{className:"map",children:[a.jsx(ne,{phLl:"Map"}),a.jsx("div",{className:"map-body",children:a.jsx(de,{asts:h,astsTableFields:t})})]})};export{xe as default};
